<!DOCTYPE html>
<html>
<head>
  <title>Test Plugin</title>
</head>
<body>
  <div id="test-plugin"></div>
  <button onclick="parent.postMessage({ pluginMessage: { type: 'start-export' } }, '*')">
    Export Tree + Images + Fonts
  </button>  

  <script>
    const useServer = true; // Toggle this to false to fallback to manual downloads

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg?.type === 'export-tree-to-server') {
        if (useServer) {
          fetch('http://localhost:3001/save-tree', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: 'tree.json',
              contents: msg.tree
            })
          }).then(res => {
            if (!res.ok) throw new Error('Tree save failed');
            console.log('üå≥ Streamed tree.json to server');
          }).catch(err => {
            console.error('‚ùå Server tree.json export failed:', err);
          });
        } else {
          const json = JSON.stringify(msg.tree, null, 2);
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          const link = document.createElement('a');
          link.href = url;
          link.download = 'tree.json';
          link.click();
          URL.revokeObjectURL(url);
        }
      }

      if (msg?.type === 'export-image') {
        if (useServer) {
          fetch('http://localhost:3001/save-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: msg.name || 'image.png',
              bytes: msg.bytes
            })
          }).then(res => {
            if (!res.ok) throw new Error('Failed to save via server');
            console.log(`üì° Streamed image to server: ${msg.name}`);
          }).catch(err => {
            console.error('‚ùå Server image export failed:', err);
          });
        } else {
          const byteArray = new Uint8Array(msg.bytes);
          const blob = new Blob([byteArray], { type: 'image/png' });
          const url = URL.createObjectURL(blob);

          const link = document.createElement('a');
          link.href = url;
          link.download = msg.name || 'image.png';
          link.click();
          URL.revokeObjectURL(url);
        }
      }

      if (msg?.type === 'trigger-font-resolution') {
        fetch('http://localhost:3001/resolve-fonts', {
          method: 'POST'
        }).then(res => {
          if (!res.ok) throw new Error('Font resolution failed');
          console.log('üß© Fonts resolved.');
        }).catch(err => {
          console.error('‚ùå Font resolution error:', err);
        });
      }
    };
  </script>
</body>
</html>
